# ReadMe.md

*To run either simulator, a system should have at least **16GB (ideally 32GB) of RAM** and a graphics card with performance equivalent to an **NVIDIA GeForce RTX 3080 Ti** or higher. Please note as of 5-31-2023 the CARLA simulator project is a WIP for more details see the links below*

[📝 Status of Development Items (Linked Github issues)](https://www.notion.so/Status-of-Development-Items-Linked-Github-issues-2e642db35559472eaf7db667610d7087?pvs=21)

[Simulation Work Overview](https://www.notion.so/Simulation-Work-Overview-0c85d1fb54894e38b4e6be58efff086b?pvs=21)

---

# CARLA Development Overview

---

This report provides information about the available assets and maps generated by ROAR for the open-source autonomous driving simulation platform, CARLA. CARLA can be used for autonomous racing simulations by creating custom tracks and vehicles, allowing users to simulate racing scenarios in a controlled environment. The report provides descriptions and download links for the available maps and **assets compatible with Unreal Engine.**

Under the maps section, three CARLA maps are available for download, including Berkmajorv-v4, LasVegasMS, and Monza. These are all created and maintained by our Berkeley ROAR Simulation team. the Monza map is currently under development and still currently being refined and improved.

# Installing CARLA

---

Feel free to explore the built **carla_assets** shown below that can be used with your CARLA build, some of these exported builds have a Dallara vehicle as an asset included in the Sim Map. For the state of this current tutorial and to skip some debugging that may be required when using these assets, it is recommended to use the standard CARLA quickstart installation if you are a beginner. 

### Quickstart

**Install time estimate ~1hour**

[Quick start package installation - CARLA Simulator](https://carla.readthedocs.io/en/latest/start_quickstart/)

Please refer to the link for detailed instructions on how to install and run CARLA. The Assets provided should incorporate a full map install but all dependencies need to be installed and configured locally. The ***-preferNvidia*** argument is recommended when launching CARLA

### Source Build

**Install time estimate ~4+hours**

Unless you are developing in game maps and assets, please use the **quick start** installation. Users can build CARLA from the source code for development purposes. This is recommended if you want to add extra features or capabilities to CARLA or if you want to use the Unreal Editor to create assets or manipulate maps. 

**Prerequisites:** 

- Ensure you meet the system requirements (Ubuntu 18.04 or compatible, **130 GB disk space**, adequate GPU, open TCP ports).
- Before you start be aware that to download this fork of Unreal Engine, ***you need to have a GitHub account linked to Unreal Engine's account***. If you don't have this set up, please follow [this guide](https://www.unrealengine.com/en-US/ue4-on-github) before going any further.

[Building CARLA - CARLA Simulator](https://carla.readthedocs.io/en/latest/build_carla/)

The source code for CARLA is hosted on GitHub. It is recommended you use the newest version of the source build if you need to build from source. **Please note:** previous gen versions seem to have major install issues with deprecated links. @ztl1998@berkeley.edu is a great resource if you run into issues with a source build install.

# run CARLA with ART stack

---

This brief summary outlines the steps necessary to run CARLA with the AI Racing Tech (ART) stack. Please note that these instructions assume a certain level of familiarity with the CARLA simulator, ROS 2, and the associated systems. It's also important to note that your experience may vary depending on your system's configuration.

### Build:

---

1. **build race_common:** Follow the provided [Getting Started](https://ai-racing-tech-race-docs.readthedocs-hosted.com/en/latest/docs/getting_started/running_stack.html) documentation *(github login required)* to build the `race_common` package and initialize the `make carla` command. This step also includes the installation of all required dependencies and sourcing to your preferred ROS distribution.
2. **build the ros-bridge package:** The next step involves cloning and building the `carla-ros-bridge` repository. You can follow build instructions from [carla’s ros-bridge documentation here](https://carla.readthedocs.io/projects/ros-bridge/en/latest/ros_installation_ros2/) if you face issues. 
    
    Make sure to source the ros-bridge package to the ROS Foxy distribution. If you have not yet installed ROS Foxy, you can find the installation guide [here](https://docs.ros.org/en/foxy/Installation.html).
    
    ```python
    git clone git@github.com:airacingtech/ros-bridge.git
    ```
    

### Run:

---

1. **navigate to the `carla_interface` package:**
    
    ```python
    cd race_common/src/simulation/carla_interface
    ```
    
    ```bash
    race_common/src/simulation/carla_interface$ tree
    .
    ├── CMakeLists.txt
    ├── include
    │   └── carla_interface
    │       └── carla_interface.hpp
    ├── launch
    │   ├── **carla_launch_cpp_node.launch.py**
    │   └── **carla_scripts.launch.py**
    ├── package.xml
    ├── param
    │   └── carla_vars.yml
    ├── ReadMe.md
    ├── scripts
    │   ├── carla_ros_bridge_spinup.py
    │   └── run_carla.py
    └── src
        └── carla_interface.cpp
    
    6 directories, 10 files
    ```
    
2. **modify launch file:** modify the `carla_scripts.launch.py` file and set the following paths to match the directory locations on your system. Please take note that in future updates, these variables will be set in `param/carla_vars.yml` for easier management.
    
    ```python
    # IF NEEDED TO MATCH YOUR SYSTEM, CHANGE THE FOLLOWING VARIABLES:
    
    # - CARLA_SIM_PATH: Specify the path to the CARLA Simulator directory.
    # - OS: Specify the operating system (Windows or Linux).
    # - CARLA_ROS_BRIDGE_PATH: Specify the path to the CARLA ROS bridge package directory.
    
    # DEFAULT VALUES:
    
    # CARLA_SIM_PATH Default: "/opt/carla-simulator"
    # OS Default: "Linux"
    # CARLA_ROS_BRIDGE_PATH Default:
    #     - Linux: "/home/USER"
    #     - Windows: "C:\Users\USERNAME"
    
    CUSTOMIZE = True
    CARLA_SIM_PATH = '/opt/carla-simulator'
    OS = 'Linux'
    CARLA_ROS_BRIDGE_PATH = '/home/ckwolfe'
    ```
    
3. **Launch  `carla_scripts.launch.py`:** Open terminal 1, navigate to the **`race_common`** directory and source and execute the following command, you should see the CARLA simulator pygame window open. This script launches the build of CARLA at the specified path and spins up the ROS bridge with an example ego vehicle. For more information, refer to the scripts **`carla_ros_bridge_spinup.py`** and **`run_carla.py`**.
    
    ```python
    cd .../race_common
    source install/setup.bash
    ros2 launch carla_interface carla_scripts.launch.py
    ```
    
4. **Launch** **`carla_launch_cpp_node.launch.py`**: Open Terminal 2, navigate to the **`race_common`** directory and source and run the command below to spin up the **`carla_interface.cpp`** node
    
    ```python
    cd .../race_common
    source install/setup.bash
    ros2 launch carla_interface carla_launch_cpp_node.launch.py
    ```
    
5. **Run** **`sin_steer_throttle.py`**: Open Terminal 3, navigate to the **`race_common/tools/scripts/`**  directory and source, and run the command below to run the **`sin_steer_throttle.py`**  script.
    
    ```python
    cd .../race_common/tools/scripts
    source install/setup.bash
    python3 sin_steer_throttle.py
    ```
    

---

**You should now see a vehicle driving sporadically in circles:**

feel free to change the values in **`sin_steer_throttle.py`** to see differences in behavior

*{ will add video demo }* 

---

---

## Misc Suggestions:

**void publishTestCommand()**

The subscribers in the system are designed to automatically ingest a new message as it’s published. The `CarlaInterfaceNode` is responsible for publishing messages from the ART stack to CARLA, and vice versa. Currently, only a few message types are mapped between the two systems, and you will need to extend this mapping as you add more topics to the stack. You can experiment with the current setup by adding a `publishTestCommand()`  the `timerCallback()` function in the current implementation. This is a placeholder and you are encouraged to modify it to test new logic implemented in the node if you need to test a message is being mapped correctly.

Detailed information about the message types used can be found in the `carla_msgs` and `race_msgs` repositories on GitHub.

---

```
/**
 * @brief Publishes test VehicleControlCommand.
 *
 * This function generates and publishes a test VehicleControlCommand. 
 * This message includes oscillating throttle and steering commands, 
 * that are meant to simulate a test drive scenario for the vehicle.
 * 
 * The published VehicleControlCommand will be picked up by the race_vehicle_control_subscriber_.
 * The subscriber will then map and publish these commands to the Carla simulator via the 
 * carla_egovehicle_control_publisher_. This allows for testing the end-to-end command
 * processing and vehicle control in the Carla simulator environment.
 * 
 * This function is primarily intended for testing and debugging purposes.
 */
void publishTestCommand()
{
  race_msgs::msg::VehicleControlCommand msg;

  // Log and publish the control command
  RCLCPP_INFO(this->get_logger(), "publishTestCommand() Publishing race_msgs::msg::VehicleControlCommand");

  // Oscillate throttle slower
  static int throttle_count = 0;
  msg.accelerator_cmd = std::sin(throttle_count * 0.01); // Adjust this value to change oscillation rate
  throttle_count++;

  // Oscillate steering faster
  static int steer_count = 0;
  msg.steering_cmd = std::sin(steer_count * 0.1); // Adjust this value to change oscillation rate
  steer_count++;

  msg.brake_cmd = 0.0; // No braking
  msg.lon_control_type = msg.LON_CONTROL_THROTTLE; // Use throttle and brake for control
  msg.gear_cmd = 2; // Second gear
  msg.emergency_stop_cmd = false; // No emergency stop

  // Publishing the message
  race_vehicle_control_publisher_->publish(msg);
}
```

# carla_assets

---

This ReadMe provides an overview of the ROAR generated assets available for [CARLA](https://carla.org/), an open-source autonomous driving simulation platform. Below are the descriptions and download links for the available maps and assets compatible with [Unreal Engine](https://www.unrealengine.com/en-US/).

[CARLA](https://carla.org/) can be used for autonomous racing simulations by creating custom tracks and vehicles, allowing users to simulate racing scenarios in a controlled environment. With [CARLA’s](https://carla.org/) realistic physics engine, sensor simulation, and ability to handle large-scale scenarios, it provides a platform for testing and validating algorithms for autonomous racing. This can include everything from testing and tuning controllers and path planners to evaluating the performance of different perception systems. Additionally, [CARLA’s](https://carla.org/) support for multiplayer modes allows users to simulate complex scenarios with multiple autonomous agents racing against each other, allowing for a more realistic testing environment for autonomous racing algorithms. Overall, [CARLA](https://carla.org/) provides a powerful platform for testing and developing autonomous racing technologies in a safe and controlled environment.

## Maps

---

### Berkmajorv-v4

- Berkmajorv-v4 is a map available for download as a final build output. The `.umap` file is located in the `/Map` folder and contains “lvmotor” in the name. You can download the map from [Google Drive](https://drive.google.com/file/d/1s5djlEuowGN7iA_msSgtj03oz9GYPk2v/view?usp=share_link).

### LasVegasMS

- LasVegasMS Map LasVegasMS a map that includes a Dallara car model, and it is available for download as a final build output. The `.umap` file is located in the `/Map` folder and contains “lvmotor” in the name. You can download the map from [Google Drive](https://drive.google.com/file/d/1DuiVyeDa2wZG9VqANIHY8J_2BDnTh0aB/view?usp=share_link).
- RoadRunner Files To generate detailed map data for LasVegasMS, you can use RoadRunner. The RoadRunner files for Las Vegas Motor Speedway are available for download from [Google Drive](https://drive.google.com/file/d/1PlT7ZZ2_NOo-e-p9YAinU7eXX0Ffqx-J/view?usp=drivesdk).

### Monza

- The Monza map is available for download as an `.fbx` file. The latest version as of 03/28/2023 is `Monza.v3.fbx` and can be downloaded from [Google Drive](https://drive.google.com/file/d/1NQ4E38vN6RpNKqeLekjFbQH87IyYQqF8/view?usp=share_link). Note that this map may not yet be runable in Carla due to some server bugs.

## Other Assets

---

### Dallara Car Model

- The Dallara car model is available for download as an `.fbx` file. However as of 4-21-2023, it may be missing physics and controller files. Please contact @C.K. Wolfe  for additional details.

### *Trouble Downloading?*

*If you find and of these CARLA asset links changed or deprecated please check the following [consolidated Dropbox assets](https://www.dropbox.com/sh/tdd9uu9mt1d9mtw/AABamSBn6RRJAVOAvu0DdSW1a?dl=0)*
